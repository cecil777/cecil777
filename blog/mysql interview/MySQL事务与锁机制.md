# MySQL 事务与锁机制

- 事务:一组操作要么全部成功，要么全部失败，目的是为了保证数据最终的一致性。

## 事务ACID特性

- 原子性（Atomicity）：当前事务的操作要么同时成功，要么同时失败。原子性由 `undo log`日志来保证。
- 一致性（Consistency）：使用事务的最终目的，由业务代码正确逻辑保证。
- 隔离性（Isolation）：在事务并发执行时，他们内部的操作不能互相干扰。
- 持久性（Durability）：一旦提交了事务，它对数据库的改变就应该是永久性的。持久性由 `redo log`日志来保证。

## 事务隔离性

InnoDB 引擎中，定义了四种隔离级别供我们使用，级别越高事务隔离性越好，但性能就越低，而隔离性是由MySQL的各种锁以及MVCC机制来实现的。

- read uncommit(读未提交)：有脏读问题
- read commit（读已提交）：有不可重复读问题
- repeatable read（可重复读）：有幻读问题
- serializable（串行）：上面问题全部解决

## 锁

- 读锁（共享锁、S锁）：select ... lock in share mode;
读锁是共享的，多个事务可以同时读取一个资源，但不允许其他事务修改
- 写锁（排它锁、X锁）：select ... for update;
写锁是排他的，会阻塞其他的写锁和读锁，update，delete，insert都会加写锁

## mvcc机制

MVCC（Multi-Version Concurrency Control）多版本并发控制，就可以做到读写不阻塞，且避免了类似脏读这样的问题，主要通过undo日志链来实现。

- read commit（读已提交），语句级快照
- repeatable read（可重复读），事务级快照

## 事务优化

### 事务是什么
事务是指访问可能更新数据库中各种数据项的一个程序执行单元（Unit）

事务应该具有四个属性：原子性，一致性，隔离性，持久性这四个属性通常称为ACID特性。



### 长事务的影响
- 并发情况下，数据库连接池容易被撑爆
- 锁定太多的数据，造成大量的阻塞和锁超时
- 执行时间长，容易造成主从延迟
- 回滚所需要的时间比较长
- undo log膨胀
- 容易造成死锁


























