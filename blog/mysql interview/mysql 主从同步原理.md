## MySQL 主从同步原理

### MySQL主从同步的过程

MySQL 的主从复制主要有三个线程：master(binlog dump thread)、slave(I/O thread、SQL thread)，Master一条线程和Slave中的两条线程。

- 主节点binlog，主从复制的基础是主库记录数据库的所有变更记录到binlog。binlog是数据库服务器启动的那一刻起，保存所有修改数据库结构或内容的一个文件。
- 主节点log dump线程，当binlog有变动时，log dump线程读取其内容并发送给从节点。
- 从节点I/O线程接收binlog内容，并将其写入到relay log文件中。
- 从节点的SQL线程读取到relay log文件内容对数据更新进行重放，最终保证主从数据库的一致性

注：主从节点使用binlog文件+position偏移量来定位主从同步的位置，从节点会保存其已接收到的偏移量，如果从节点发生宕机重启，则会自动从position的位置发起同步。

由于MySQL默认的复制方式是异步的，主库把日志发送给从库后不关心从库是否已处理，这样会产生一个问题就是假设主库挂了，从库处理失败了，这时候从库升为主库后，日志就丢失了。由此产生两个概念。

#### 全同步复制

主库写入binlog后强制同步日志到从库，所有的从库都执行完成后才返回给客户端，但是很显然这个方式的话性能会受到严重影响。

#### 半同步复制

和全同步复制不同的是，半同步复制的逻辑是，从库写入日志成功后返回ACK确认给主库，主库收到至少一个从库的确认就认为写操作完成。
